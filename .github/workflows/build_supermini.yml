name: Build SuperMini Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.1.2
        target: esp32s3
        extra_cmake_args: -DMCU=esp32s3

    - name: Apply SuperMini pin configuration
      run: |
        echo "应用SuperMini引脚配置..."
        # 创建自定义配置文件
        cat > sdkconfig.supermini << 'EOF'
        #
        # SuperMini引脚配置
        #
        CONFIG_I2S_MIC_DATA=4
        CONFIG_I2S_MIC_CLOCK=5
        CONFIG_I2S_MIC_WS=6
        CONFIG_I2S_SPK_DATA=9
        CONFIG_I2S_SPK_BCLK=10
        CONFIG_I2S_SPK_LRCK=11
        CONFIG_OLED_SDA=12
        CONFIG_OLED_SCL=13
        
        # 硬件类型配置
        CONFIG_MIC_TYPE_INMP441=y
        CONFIG_SPK_TYPE_MAX98357A=y
        
        # ESP32-S3特定配置
        CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
        CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240=y
        CONFIG_PARTITION_TABLE_CUSTOM=y
        CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions.csv"
        
        # 功能配置
        CONFIG_AUDIO_CODEC_MP3_DECODER=y
        CONFIG_SR_WN5Q16_MODEL=y
        CONFIG_SR_MN5_CHINESE=y
        EOF
        
        # 应用配置
        idf.py reconfigure

    - name: Build project
      run: |
        source $IDF_PATH/export.sh
        idf.py build

    - name: Collect firmware artifacts
      run: |
        mkdir -p firmware_artifacts
        cp build/*.bin firmware_artifacts/
        cp build/partition_table/partition-table.bin firmware_artifacts/
        cp build/bootloader/bootloader.bin firmware_artifacts/
        cp sdkconfig firmware_artifacts/
        ls -la firmware_artifacts/

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xiaozhi-supermini-firmware
        path: firmware_artifacts/
        retention-days: 30
